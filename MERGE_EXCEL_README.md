省流：
打开main文件夹并在终端输入：
```bash
python merge_excel.py   -p "买入平均收益_净值列表/日度净值_产品*.xlsx"   -s 20240101   --rule friday
```
就可以得到一个 `买入收益_每周五买入.xlsx`

# merge_excel.py - 多产品Excel合并与收益计算工具

## 功能概述

这是一个命令行工具，用于：
1. **合并多个产品的日度净值文件** - 将多个 `日度净值_产品*.xlsx` 合并成一个标准格式的Excel文件
2. **设置统一的买入起点日期** - 过滤指定日期之后的数据
3. **计算周期性买入收益** - 根据指定的买入规则（每周五、每月指定日等）计算持有收益

## 基本用法

### 1. 仅合并产品文件（不计算收益）

```bash
python merge_excel.py -p "买入平均收益_净值列表/日度净值_产品*.xlsx"
```

输出：`日度净值_合并.xlsx`（同目录下）

### 2. 指定统一的买入起点日期

```bash
python merge_excel.py -p "买入平均收益_净值列表/日度净值_产品*.xlsx" -s 20240101
```

- 所有产品的数据将从 `2024年1月1日` 开始
- 更早的数据会被过滤掉

### 3. 计算周期性买入收益

#### 每周五买入规则

```bash
python merge_excel.py -p "买入平均收益_净值列表/日度净值_产品*.xlsx" --rule friday
```

输出两个文件：
- `日度净值_合并.xlsx` - 合并的产品数据
- `买入收益_每周五买入.xlsx` - 每周五买入的收益计算结果

#### 每月20日买入规则（默认）

```bash
python merge_excel.py -p "买入平均收益_净值列表/日度净值_产品*.xlsx" --rule monthly
```

或指定其他日期：

```bash
python merge_excel.py -p "买入平均收益_净值列表/日度净值_产品*.xlsx" --rule monthly --day 15
```

#### 每周指定日期买入规则

```bash
python merge_excel.py -p "买入平均收益_净值列表/日度净值_产品*.xlsx" --rule weekly --weekday 0
```

- `0` = 周一，`1` = 周二，...，`4` = 周五，...，`6` = 周日

#### 指定日期买入规则

```bash
python merge_excel.py -p "买入平均收益_净值列表/日度净值_产品*.xlsx" --rule specific --target-date 2024-01-15
```

### 4. 组合使用所有参数

```bash
python merge_excel.py \
  -p "买入平均收益_净值列表/日度净值_产品*.xlsx" \
  -s 20240101 \
  --rule friday \
  -o "买入平均收益_净值列表/日度净值.xlsx" \
  --returns-output "买入平均收益_净值列表/买入收益明细.xlsx"
```

这会：
1. 加载所有产品文件
2. 过滤到 2024年1月1日 及以后的数据
3. 计算每周五买入的收益
4. 将合并数据保存到指定路径
5. 将收益计算结果保存到指定路径

### 5. 使用目录模式（替代模式模式）

```bash
python merge_excel.py -d "买入平均收益_净值列表" --rule friday -o "买入平均收益_净值列表/日度净值.xlsx"
```

- `-d` 和 `-p` 是互斥的，选其一即可

## 参数详解

### 输入参数（必选，二选一）

| 参数 | 说明 | 示例 |
|------|------|------|
| `-p, --pattern` | 产品文件的通配符模式 | `日度净值_产品*.xlsx` |
| `-d, --directory` | 包含产品文件的目录 | `买入平均收益_净值列表` |

### 通用参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `-o, --output` | 合并文件的输出路径 | `日度净值_合并.xlsx` |
| `-s, --start-date` | 统一的买入起点日期（YYYYMMDD） | 无（保留所有数据） |

### 买入规则参数

| 参数 | 说明 | 可选值 |
|------|------|--------|
| `--rule` | 买入规则类型 | `friday`, `monthly`, `weekly`, `specific` |
| `--day` | 每月第几天（月度规则用） | 1-28，默认20 |
| `--weekday` | 每周第几天（周度规则用） | 0-6（0=周一，6=周日） |
| `--target-date` | 指定买入日期（具体规则用） | YYYY-MM-DD 或 YYYYMMDD |
| `--returns-output` | 收益结果输出文件路径 | 自动生成 |

## 输出文件说明

### 1. 合并的产品文件

文件名：`日度净值_合并.xlsx`

结构：
- 每个sheet的名称是 **产品简称**（如：产品1、产品2等）
- 每个sheet的格式：
  - A1: 产品名称
  - B1: 产品代码
  - A2-C2: 列标题（日期、单位净值、累计净值）
  - A3+: 数据行（日期为YYYYMMDD格式）

### 2. 收益计算结果文件

文件名：`买入收益_{规则名}.xlsx`

结构：
- 每个sheet对应一个产品（sheet名为产品简称）
- 包含以下列：
  - **买入日期**: 符合规则的买入日期
  - **买入基金净值**: 该日期的单位净值
  - **每日涨跌幅**: 买入当日的涨跌幅
  - **持有天数**: 从买入日到最新数据的持有天数
  - **区间收益率**: (最新净值 / 买入净值) - 1
  - **区间年化收益率**: 年化的区间收益率

## 示例场景

### 场景1: 合并5个产品，并计算每周五买入的收益

```bash
python merge_excel.py \
  -d "买入平均收益_净值列表" \
  --rule friday
```

这会：
1. 自动搜索 `买入平均收益_净值列表` 目录下的所有 `日度净值_产品*.xlsx` 文件
2. 将它们合并成 `日度净值_合并.xlsx`
3. 计算每周五买入的收益，保存到 `买入收益_每周五买入.xlsx`

### 场景2: 从2024年1月1日开始，计算每月20日买入的收益

```bash
python merge_excel.py \
  -p "买入平均收益_净值列表/日度净值_产品*.xlsx" \
  -s 20240101 \
  --rule monthly \
  --day 20 \
  -o "买入平均收益_净值列表/日度净值.xlsx"
```

这会：
1. 加载所有5个产品
2. 过滤到2024年1月1日及以后
3. 计算每月20日（或当月最接近的交易日）的买入收益
4. 输出合并文件到指定路径

## 常见问题

### Q1: 如果产品文件不存在怎么办？

**A:** 工具会显示错误信息，并列出查找的文件模式。请检查：
1. 文件路径是否正确
2. 通配符模式是否匹配
3. 文件是否真的存在

### Q2: 指定的日期没有交易怎么办？

**A:** 对于月度规则，会自动顺延到该月最接近的下一个交易日。对于周度规则，会跳过无交易的日期。

### Q3: 如何只计算收益不合并文件？

**A:** 目前不支持只计算不合并。但你可以：
1. 先合并文件（生成日度净值_合并.xlsx）
2. 然后用 `periodic_buy.py` 计算特定产品的收益

### Q4: 支持多少个产品？

**A:** 理论上无限制，但取决于你的系统内存。通常支持数百个产品文件。

## 需要帮助？

运行以下命令查看完整的帮助信息：

```bash
python merge_excel.py --help
```
