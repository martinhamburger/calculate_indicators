省流1：
打开main文件夹并在终端输入
python calculate.py -d ./净值列表
即可获得一个output.

省流2：
打开main文件夹并在终端输入
python buy_avg_return.py -f 买入平均收益_净值列表/日度净值.xlsx
即可获得一个买入平均_output.

更进一步的格式要求：
A1是产品名称，B1是产品代码。
A2-C2是表头。
A3开始是数据。
.xlsx放入净值列表文件夹即可.



# 产品净值计算器

产品净值业绩指标计算工具，支持单个文件或批量处理目录下所有Excel文件。

## 功能特点

- 支持倒序数据（日期从新到旧排列）
- 自动计算年化收益率、波动率、夏普比率、最大回撤等指标
- 支持年度、月度多维度分析
- 输出Excel文件自动设置列宽，便于查看

## Excel 格式要求

每个产品的Excel文件需按以下格式组织：

|  | A | B | C |
|---|---|---|---|
| **1** | 产品名称 | 产品代码 |  |
| **2** | 日期 | 单位净值 | 累计净值 |
| **3** | 20260116 | 2.9353 | 2.9353 |
| **4** | 20260112 | 2.8195 | 2.8195 |
| **5** | 20260109 | 2.8323 | 2.8323 |
| ... | ... | ... | ... |

**说明：**
- A1：产品名称（如 "锐进58源乐晟尊享A"）
- B1：产品代码（如 "XA1796"）
- A2-C2：列标题（日期、单位净值、累计净值）
- A3起：净值数据（日期格式：YYYYMMDD）
- 数据按**日期倒序**排列（最新日期在前）

**注意：** 计算中仅使用"单位净值"列，"累计净值"列不参与计算。

## 安装依赖

```bash
pip install pandas openpyxl
```

## 命令行使用

### 处理单个文件

```bash
# 基本用法
python calculate.py -f 产品净值.xlsx

# 指定输出目录
python calculate.py -f 产品净值.xlsx -o ./results

# 指定无风险利率（默认2%）
python calculate.py -f 产品净值.xlsx --risk-free 0.03
```

### 批量处理目录

```bash
# 处理目录下所有Excel文件
python calculate.py -d ./净值目录

# 处理并生成汇总文件
python calculate.py -d ./净值目录 -s 汇总.xlsx

# 指定输出目录和汇总文件名
python calculate.py -d ./净值目录 -o ./results -s 业绩汇总.xlsx
```

## 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `-f, --file` | 单个Excel文件路径 | - |
| `-d, --dir` | 包含Excel文件的目录路径 | - |
| `-o, --output` | 输出目录 | `./output` |
| `-s, --summary` | 汇总文件名（多文件时生成） | `业绩汇总.xlsx` |
| `--risk-free` | 无风险利率 | `0.02` (2%) |

## 输出说明

### 单个产品输出

每个产品生成一个独立的Excel文件（`_结果.xlsx`），包含以下sheet：

1. **业绩指标计算** - 产品名称、代码、最新净值日期、最新净值、成立以来收益率、年化收益率、年化波动率、夏普比率、最大回撤及日期、近一年最大回撤及日期
2. **年度收益率** - 各年度收益率明细
3. **周频计算历史最大回撤** - 基于周频数据的年度最大回撤
4. **月频计算历史最大回撤** - 基于月频数据的年度最大回撤
5. **成立以来月度收益** - 月度收益矩阵及全年收益

**输出特点：**
- 各sheet自动设置列宽，便于查看完整数据
- 数值型数据自动保留4位小数
- 日期格式保持原样显示

### 汇总文件输出

处理多个产品时，自动生成汇总文件 `业绩汇总.xlsx`，包含所有产品的核心业绩指标，按成立以来收益率降序排列。

## Python API 使用

```python
from utils import ProductNetValueCalculator

# 创建计算器
calculator = ProductNetValueCalculator(
    file_path="产品净值.xlsx",
    risk_free_rate=0.02  # 可选，默认2%
)

# 执行所有计算
calculator.run_all_calculations()

# 打印摘要
calculator.print_summary()

# 保存详细结果
calculator.save_to_excel("产品净值_结果.xlsx")

# 获取各维度数据
annual_returns = calculator.get_annual_returns()
monthly_matrix = calculator.get_monthly_return_matrix()
metrics_df = calculator.build_metrics_df()
```

## 计算指标说明

| 指标 | 说明 |
|------|------|
| 成立以来收益率 | 最新净值 / 首日净值 - 1 |
| 年化收益率 | (1 + 成立以来收益率)^(52/周数) - 1 |
| 年化波动率 | 周收益率标准差 × √52 |
| 夏普比率 | (年化收益率 - 无风险利率) / 年化波动率 |
| 最大回撤 | 历史最高净值到最低净值的最大跌幅 |
| 近一年最大回撤 | 近一年期间的最大回撤 |

## 数据要求

- 每个Excel文件至少需要 **2条** 净值数据才能进行计算
- 日期格式支持 `YYYYMMDD`（如 20260116）
- 数据按日期**倒序**排列（最新日期在前，最早日期在后）
- 支持 `.xlsx`、`.xls`、`.xlsm` 格式

---

# 买入平均收益计算器

计算每月指定开放日（默认20日）以来的收益，支持命令行和Python API两种使用方式。

## 功能特点

- 每月20日作为开放日（如无20日则跳过）
- 计算每个开放日买入持有至今的收益率
- 按年份分组输出为格式化的txt文件
- 支持自定义开放日日期

## 命令行使用

```bash
# 基本用法
python buy_avg_return.py -f 买入平均收益_净值列表/日度净值.xlsx

# 指定输出目录
python buy_avg_return.py -f 买入平均收益_净值列表/日度净值.xlsx -o ./买入平均_output
```

## 输出示例

生成的txt文件格式如下：

```
⭐️2025年
🔺1月买入平均收益37.39%
🔺2月买入平均收益24.64%
🔺3月买入平均收益21.37%
🔺5月买入平均收益31.35%
🔺6月买入平均收益35.38%
🔺8月买入平均收益15.84%
🔺10月买入平均收益9.91%
🔺11月买入平均收益11.76%

⭐️2024年
🔺2月买入平均收益66.30%
🔺3月买入平均收益52.27%
...
```

## Python API 使用

```python
from utils import BuyAvgReturnCalculator

# 创建计算器
calculator = BuyAvgReturnCalculator("日度净值.xlsx")

# 执行所有计算
calculator.run_all()

# 获取产品信息
info = calculator.get_product_info()
print(f"产品名称: {info['name']}")
print(f"数据日期范围: {info['date_range']}")
print(f"开放日数量: {info['open_day_count']}")

# 获取结果（字典格式）
results = calculator.results
# results 格式: {年份: {月份: 收益率}}

# 生成格式化文本
text = calculator.generate_output_text()

# 保存到txt文件
calculator.save_to_txt("output.txt")
```

## BuyAvgReturnCalculator 类方法

| 方法 | 说明 |
|------|------|
| `__init__(file_path)` | 初始化，指定Excel文件路径 |
| `get_open_day_data(day=20)` | 获取指定日期的开放日数据 |
| `calculate_returns_since_open_day()` | 计算每个开放日以来的收益率 |
| `generate_output_text()` | 生成格式化的输出文本 |
| `save_to_txt(output_path)` | 保存结果到txt文件 |
| `get_product_info()` | 获取产品信息（名称、代码、日期范围等） |
| `run_all()` | 执行所有计算步骤 |
